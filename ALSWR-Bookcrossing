{"cells":[{"cell_type":"code","execution_count":1,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"elapsed":8382,"status":"ok","timestamp":1644130822042,"user":{"displayName":"1982 Avis Priyati","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"04182794466118726271"},"user_tz":0},"id":"-yLrw29HALw0","outputId":"05226cd8-b9d9-4586-cb9d-5dab09b20069"},"outputs":[{"output_type":"stream","name":"stdout","text":["\u001b[33m\r0% [Working]\u001b[0m\r            \rGet:1 https://cloud.r-project.org/bin/linux/ubuntu bionic-cran40/ InRelease [3,626 B]\n","\u001b[33m\r0% [Connecting to archive.ubuntu.com (91.189.88.152)] [Waiting for headers] [Co\u001b[0m\u001b[33m\r0% [1 InRelease gpgv 3,626 B] [Connecting to archive.ubuntu.com (91.189.88.152)\u001b[0m\r                                                                               \rGet:2 http://security.ubuntu.com/ubuntu bionic-security InRelease [88.7 kB]\n","Ign:3 https://developer.download.nvidia.com/compute/cuda/repos/ubuntu1804/x86_64  InRelease\n","Ign:4 https://developer.download.nvidia.com/compute/machine-learning/repos/ubuntu1804/x86_64  InRelease\n","Get:5 https://developer.download.nvidia.com/compute/cuda/repos/ubuntu1804/x86_64  Release [696 B]\n","Hit:6 https://developer.download.nvidia.com/compute/machine-learning/repos/ubuntu1804/x86_64  Release\n","Get:7 https://developer.download.nvidia.com/compute/cuda/repos/ubuntu1804/x86_64  Release.gpg [836 B]\n","Hit:8 http://ppa.launchpad.net/c2d4u.team/c2d4u4.0+/ubuntu bionic InRelease\n","Hit:9 http://archive.ubuntu.com/ubuntu bionic InRelease\n","Get:10 http://archive.ubuntu.com/ubuntu bionic-updates InRelease [88.7 kB]\n","Hit:11 http://ppa.launchpad.net/cran/libgit2/ubuntu bionic InRelease\n","Hit:12 http://ppa.launchpad.net/deadsnakes/ppa/ubuntu bionic InRelease\n","Get:13 http://archive.ubuntu.com/ubuntu bionic-backports InRelease [74.6 kB]\n","Get:14 http://ppa.launchpad.net/graphics-drivers/ppa/ubuntu bionic InRelease [21.3 kB]\n","Get:16 https://developer.download.nvidia.com/compute/cuda/repos/ubuntu1804/x86_64  Packages [917 kB]\n","Get:17 http://security.ubuntu.com/ubuntu bionic-security/main amd64 Packages [2,544 kB]\n","Get:18 http://security.ubuntu.com/ubuntu bionic-security/universe amd64 Packages [1,466 kB]\n","Get:19 http://security.ubuntu.com/ubuntu bionic-security/restricted amd64 Packages [760 kB]\n","Get:20 http://archive.ubuntu.com/ubuntu bionic-updates/main amd64 Packages [2,986 kB]\n","Get:21 http://archive.ubuntu.com/ubuntu bionic-updates/universe amd64 Packages [2,244 kB]\n","Get:22 http://ppa.launchpad.net/graphics-drivers/ppa/ubuntu bionic/main amd64 Packages [42.8 kB]\n","Fetched 11.2 MB in 5s (2,185 kB/s)\n","Reading package lists... Done\n","Building dependency tree       \n","Reading state information... Done\n","55 packages can be upgraded. Run 'apt list --upgradable' to see them.\n"]}],"source":["! apt update"]},{"cell_type":"code","execution_count":2,"metadata":{"id":"Z3Riz5g990hW","executionInfo":{"status":"ok","timestamp":1644130851788,"user_tz":0,"elapsed":29759,"user":{"displayName":"1982 Avis Priyati","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"04182794466118726271"}}},"outputs":[],"source":["#Java JDK\n","!apt-get install openjdk-8-jdk-headless -qq > /dev/null\n","#Downloading Spark\n","!wget -q https://archive.apache.org/dist/spark/spark-3.0.0/spark-3.0.0-bin-hadoop3.2.tgz\n","#Unzipping the hadoop file\n","!tar xf spark-3.0.0-bin-hadoop3.2.tgz"]},{"cell_type":"code","execution_count":11,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"elapsed":1779,"status":"ok","timestamp":1644131425984,"user":{"displayName":"1982 Avis Priyati","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"04182794466118726271"},"user_tz":0},"id":"xk5wePix94Ef","outputId":"dff7bf11-db3a-4385-811a-4cc4af8d026b"},"outputs":[{"output_type":"stream","name":"stdout","text":["Archive:  book1M.zip\n","   creating: book1M/\n","  inflating: book1M/BX-Book-Ratings.csv  \n","  inflating: book1M/BX-Books.csv     \n","  inflating: book1M/BX-Users.csv     \n","  inflating: book1M/explicit_ratings_books.csv  \n"]}],"source":["#Unzip the file\n","!unzip book1M.zip"]},{"cell_type":"code","execution_count":4,"metadata":{"id":"xie483cW980m","executionInfo":{"status":"ok","timestamp":1644130856287,"user_tz":0,"elapsed":4207,"user":{"displayName":"1982 Avis Priyati","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"04182794466118726271"}}},"outputs":[],"source":["###################### SPARK SETUP ################################\n","#Install findspark\n","!pip install -q findspark"]},{"cell_type":"code","execution_count":5,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"elapsed":3716,"status":"ok","timestamp":1644130859990,"user":{"displayName":"1982 Avis Priyati","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"04182794466118726271"},"user_tz":0},"id":"uetiZ7hS9_C7","outputId":"0cd29f5f-9766-4664-fbc6-85c7ffc58e32"},"outputs":[{"output_type":"stream","name":"stdout","text":["Collecting py4j\n","  Downloading py4j-0.10.9.3-py2.py3-none-any.whl (198 kB)\n","\u001b[?25l\r\u001b[K     |█▋                              | 10 kB 26.9 MB/s eta 0:00:01\r\u001b[K     |███▎                            | 20 kB 33.9 MB/s eta 0:00:01\r\u001b[K     |█████                           | 30 kB 29.9 MB/s eta 0:00:01\r\u001b[K     |██████▋                         | 40 kB 21.6 MB/s eta 0:00:01\r\u001b[K     |████████▎                       | 51 kB 9.2 MB/s eta 0:00:01\r\u001b[K     |█████████▉                      | 61 kB 8.0 MB/s eta 0:00:01\r\u001b[K     |███████████▌                    | 71 kB 8.9 MB/s eta 0:00:01\r\u001b[K     |█████████████▏                  | 81 kB 10.0 MB/s eta 0:00:01\r\u001b[K     |██████████████▉                 | 92 kB 10.6 MB/s eta 0:00:01\r\u001b[K     |████████████████▌               | 102 kB 8.3 MB/s eta 0:00:01\r\u001b[K     |██████████████████▏             | 112 kB 8.3 MB/s eta 0:00:01\r\u001b[K     |███████████████████▊            | 122 kB 8.3 MB/s eta 0:00:01\r\u001b[K     |█████████████████████▍          | 133 kB 8.3 MB/s eta 0:00:01\r\u001b[K     |███████████████████████         | 143 kB 8.3 MB/s eta 0:00:01\r\u001b[K     |████████████████████████▊       | 153 kB 8.3 MB/s eta 0:00:01\r\u001b[K     |██████████████████████████▍     | 163 kB 8.3 MB/s eta 0:00:01\r\u001b[K     |████████████████████████████    | 174 kB 8.3 MB/s eta 0:00:01\r\u001b[K     |█████████████████████████████▋  | 184 kB 8.3 MB/s eta 0:00:01\r\u001b[K     |███████████████████████████████▎| 194 kB 8.3 MB/s eta 0:00:01\r\u001b[K     |████████████████████████████████| 198 kB 8.3 MB/s \n","\u001b[?25hInstalling collected packages: py4j\n","Successfully installed py4j-0.10.9.3\n"]}],"source":["!pip install py4j"]},{"cell_type":"code","execution_count":6,"metadata":{"id":"W97LNBHW-4zO","executionInfo":{"status":"ok","timestamp":1644130859990,"user_tz":0,"elapsed":14,"user":{"displayName":"1982 Avis Priyati","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"04182794466118726271"}}},"outputs":[],"source":["#Setting up environment variables\n","import os\n","os.environ[\"JAVA_HOME\"] = \"/usr/lib/jvm/java-8-openjdk-amd64\"\n","os.environ[\"SPARK_HOME\"] = \"/content/spark-3.0.0-bin-hadoop3.2\""]},{"cell_type":"code","execution_count":7,"metadata":{"colab":{"base_uri":"https://localhost:8080/","height":196},"executionInfo":{"elapsed":9934,"status":"ok","timestamp":1644130869910,"user":{"displayName":"1982 Avis Priyati","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"04182794466118726271"},"user_tz":0},"id":"uLjmc1d--BE5","outputId":"c648f97e-e548-4475-c777-018937d47b4f"},"outputs":[{"output_type":"execute_result","data":{"text/html":["\n","        <div>\n","            <p><b>SparkContext</b></p>\n","\n","            <p><a href=\"http://94dea11271aa:4040\">Spark UI</a></p>\n","\n","            <dl>\n","              <dt>Version</dt>\n","                <dd><code>v3.0.0</code></dd>\n","              <dt>Master</dt>\n","                <dd><code>local[*]</code></dd>\n","              <dt>AppName</dt>\n","                <dd><code>pyspark-shell</code></dd>\n","            </dl>\n","        </div>\n","        "],"text/plain":["<SparkContext master=local[*] appName=pyspark-shell>"]},"metadata":{},"execution_count":7}],"source":["#Initialize Spark session using findspark lib\n","import findspark\n","findspark.init()\n","from pyspark.sql import SparkSession\n","spark = SparkSession.builder.master(\"local[*]\").getOrCreate()\n","sc = spark.sparkContext\n","sc"]},{"cell_type":"code","execution_count":8,"metadata":{"id":"weXJ8qyfpVXF","executionInfo":{"status":"ok","timestamp":1644130871150,"user_tz":0,"elapsed":1257,"user":{"displayName":"1982 Avis Priyati","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"04182794466118726271"}}},"outputs":[],"source":["import os\n","import time\n","\n","from pyspark.sql import SparkSession\n","import pyspark \n","\n","from pyspark.sql.functions import lit\n","from pyspark.ml.feature import IndexToString\n","from pyspark.ml.feature import StringIndexer\n","from pyspark.sql.functions import col\n","from pyspark.ml.tuning import ParamGridBuilder, TrainValidationSplit,CrossValidator\n","from pyspark.ml.evaluation import RegressionEvaluator\n","from pyspark.ml.recommendation import ALS\n","from pyspark.ml import Pipeline, PipelineModel\n","\n","import math\n","import numpy as np\n","import pandas as pd\n","\n","\n","import seaborn as sns\n","import matplotlib.pyplot as plt\n","\n","%matplotlib inline"]},{"cell_type":"code","execution_count":9,"metadata":{"id":"7snafWyypcnh","executionInfo":{"status":"ok","timestamp":1644130871151,"user_tz":0,"elapsed":6,"user":{"displayName":"1982 Avis Priyati","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"04182794466118726271"}}},"outputs":[],"source":["from pyspark.sql import functions as f"]},{"cell_type":"markdown","metadata":{"id":"zrnte6yI-G30"},"source":["**read the data file**"]},{"cell_type":"code","execution_count":12,"metadata":{"id":"FQHcLDCZ12Le","executionInfo":{"status":"ok","timestamp":1644131445164,"user_tz":0,"elapsed":9857,"user":{"displayName":"1982 Avis Priyati","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"04182794466118726271"}}},"outputs":[],"source":["df = spark.read.csv(path = '/content/book1M/explicit_ratings_books.csv', header = True,inferSchema = True)"]},{"cell_type":"code","execution_count":13,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"elapsed":9,"status":"ok","timestamp":1644131445165,"user":{"displayName":"1982 Avis Priyati","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"04182794466118726271"},"user_tz":0},"id":"NSHz6deo1_yQ","outputId":"d46e43f7-cc8f-4a1d-c9ea-26a92a367bbb"},"outputs":[{"output_type":"stream","name":"stdout","text":["root\n"," |-- userID: integer (nullable = true)\n"," |-- ISBN: string (nullable = true)\n"," |-- rating: integer (nullable = true)\n"," |-- title: string (nullable = true)\n"," |-- author: string (nullable = true)\n"," |-- yearOfPublication: string (nullable = true)\n"," |-- publisher: string (nullable = true)\n"," |-- age: string (nullable = true)\n"," |-- country: string (nullable = true)\n","\n"]}],"source":["df.printSchema()"]},{"cell_type":"code","execution_count":14,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"elapsed":485,"status":"ok","timestamp":1644131445645,"user":{"displayName":"1982 Avis Priyati","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"04182794466118726271"},"user_tz":0},"id":"RI8xvVnU2Fd5","outputId":"648db481-598b-421c-da7c-45a7b51f3765"},"outputs":[{"output_type":"stream","name":"stdout","text":["+------+----------+------+--------------------+----------------+-----------------+--------------------+---+-------------+\n","|userID|      ISBN|rating|               title|          author|yearOfPublication|           publisher|age|      country|\n","+------+----------+------+--------------------+----------------+-----------------+--------------------+---+-------------+\n","|276726|0155061224|     5|    Rites of Passage|      Judith Rae|             2001|              Heinle| 34|          usa|\n","|276729|052165615X|     3|      Help!: Level 1|   Philip Prowse|             1999|Cambridge Univers...| 16|      croatia|\n","|276729|0521795028|     6|The Amsterdam Con...|     Sue Leather|             2001|Cambridge Univers...| 16|      croatia|\n","|276744|038550120X|     7|     A Painted House|    JOHN GRISHAM|             2001|           Doubleday| 34|          usa|\n","|276747|0060517794|     9|Little Altars Eve...|   Rebecca Wells|             2003|         HarperTorch| 25|          usa|\n","|276747|0671537458|     9|   Waiting to Exhale|  Terry McMillan|             1995|              Pocket| 25|          usa|\n","|276747|0679776818|     8|Birdsong: A Novel...|Sebastian Faulks|             1997|   Vintage Books USA| 25|          usa|\n","|276747|0943066433|     7|How to Deal With ...|   Rick Brinkman|             1995|    Careertrack Inc.| 25|          usa|\n","|276747|1885408226|     7|The Golden Rule o...|        Aye Jaye|             1998|Listen &amp; Live...| 25|          usa|\n","|276748|0747558167|     6|Apricots on the N...| Colette Rossant|             2002|Bloomsbury Publis...| 39| saudi arabia|\n","+------+----------+------+--------------------+----------------+-----------------+--------------------+---+-------------+\n","only showing top 10 rows\n","\n"]}],"source":["df.show(10,truncate=True)"]},{"cell_type":"code","execution_count":15,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"elapsed":1066,"status":"ok","timestamp":1644131446708,"user":{"displayName":"1982 Avis Priyati","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"04182794466118726271"},"user_tz":0},"id":"JsymeIKd2Zfi","outputId":"33bc1d2b-a612-49e5-e0e7-476fea3cfd97"},"outputs":[{"output_type":"execute_result","data":{"text/plain":["383842"]},"metadata":{},"execution_count":15}],"source":["df.count()"]},{"cell_type":"code","execution_count":16,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"elapsed":10978,"status":"ok","timestamp":1644131457682,"user":{"displayName":"1982 Avis Priyati","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"04182794466118726271"},"user_tz":0},"id":"iuUJvrDH2cB1","outputId":"e0422cb5-e6aa-41af-ebf5-9ffa75dda6b9"},"outputs":[{"output_type":"execute_result","data":{"text/plain":["DataFrame[summary: string, userID: string, ISBN: string, rating: string, title: string, author: string, yearOfPublication: string, publisher: string, age: string, country: string]"]},"metadata":{},"execution_count":16}],"source":["df.describe()"]},{"cell_type":"markdown","metadata":{"id":"UwfatJ8U2iDP"},"source":["**Collaborative Filtering: Data Modeling using Alternating Least Square matrix (ALS)\n","Select required columns (UserID, ISBN, Ratings)**"]},{"cell_type":"code","execution_count":17,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"elapsed":635,"status":"ok","timestamp":1644131458306,"user":{"displayName":"1982 Avis Priyati","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"04182794466118726271"},"user_tz":0},"id":"9eDpEpmE2zyi","outputId":"b0b624b0-f758-4a5a-ec11-e31cadf1622f"},"outputs":[{"output_type":"stream","name":"stdout","text":["+------+----------+------+\n","|userID|      ISBN|rating|\n","+------+----------+------+\n","|276726|0155061224|     5|\n","|276729|052165615X|     3|\n","|276729|0521795028|     6|\n","|276744|038550120X|     7|\n","|276747|0060517794|     9|\n","|276747|0671537458|     9|\n","|276747|0679776818|     8|\n","|276747|0943066433|     7|\n","|276747|1885408226|     7|\n","|276748|0747558167|     6|\n","|276751|3596218098|     8|\n","|276754|0684867621|     8|\n","|276755|0451166892|     5|\n","|276762|0380711524|     5|\n","|276762|3453092007|     8|\n","|276772|0553572369|     7|\n","|276772|3499230933|    10|\n","|276772|3596151465|    10|\n","|276774|3442136644|     9|\n","|276786|8437606322|     8|\n","+------+----------+------+\n","only showing top 20 rows\n","\n"]}],"source":["# selecting the columns to work with in the dataset, we do not need all columns for the prediction, only userID, ISBN & rating column \n","data=df.select(df['userID'],df['ISBN'],df['rating'])\n","data.show()"]},{"cell_type":"code","execution_count":18,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"elapsed":7297,"status":"ok","timestamp":1644131465599,"user":{"displayName":"1982 Avis Priyati","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"04182794466118726271"},"user_tz":0},"id":"c5achpN224FE","outputId":"7d5be142-a8f4-4d2e-adb7-0faff58aa518"},"outputs":[{"output_type":"stream","name":"stdout","text":["+------+----------+------+----------+------------+\n","|userID|      ISBN|rating|ISBN_index|userID_index|\n","+------+----------+------+----------+------------+\n","|276726|0155061224|     5|   58420.0|     56337.0|\n","|276729|052165615X|     3|   87191.0|     26364.0|\n","|276729|0521795028|     6|   87208.0|     26364.0|\n","|276744|038550120X|     7|     216.0|     56338.0|\n","|276747|0060517794|     9|    1070.0|     12196.0|\n","|276747|0671537458|     9|    2592.0|     12196.0|\n","|276747|0679776818|     8|    1951.0|     12196.0|\n","|276747|0943066433|     7|  124008.0|     12196.0|\n","|276747|1885408226|     7|  137096.0|     12196.0|\n","|276748|0747558167|     6|   42440.0|     56339.0|\n","|276751|3596218098|     8|  145073.0|     56340.0|\n","|276754|0684867621|     8|     374.0|     56341.0|\n","|276755|0451166892|     5|     198.0|     56342.0|\n","|276762|0380711524|     5|    2698.0|     26365.0|\n","|276762|3453092007|     8|   27412.0|     26365.0|\n","|276772|0553572369|     7|    6882.0|     18853.0|\n","|276772|3499230933|    10|   10685.0|     18853.0|\n","|276772|3596151465|    10|   49660.0|     18853.0|\n","|276774|3442136644|     9|   27308.0|     56343.0|\n","|276786|8437606322|     8|   50036.0|     26367.0|\n","+------+----------+------+----------+------------+\n","only showing top 20 rows\n","\n"]}],"source":["# Converting String columns (userID & ISBN) to index\n","s_indexer = [StringIndexer(inputCol=column, outputCol=column+\"_index\") for column in list(set(data.columns)-set(['rating'])) ]\n","pipeline = Pipeline(stages=s_indexer)\n","dftransform = pipeline.fit(data).transform(data)\n","dftransform.show()"]},{"cell_type":"markdown","metadata":{"id":"Hi_9vvB_Zh0m"},"source":["Membagi dataset yang sudah dilakukan cleaning ke dalam 2 bagian, Data Training\n","(80%) dan Data Testing (20%)."]},{"cell_type":"code","execution_count":31,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"elapsed":7426,"status":"ok","timestamp":1644144548243,"user":{"displayName":"1982 Avis Priyati","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"04182794466118726271"},"user_tz":0},"id":"zRO8nPsiAHW7","outputId":"4118a6a2-d93d-4a1f-c079-bef23cf5cdd3"},"outputs":[{"output_type":"stream","name":"stdout","text":["  Train dataset: 230223 rows\n","  Test dataset:  76866 rows\n","  Test dataset:  76753 rows\n"]}],"source":["# Randomly split the data into train and test and val where 80% data is in train and remaining is test\n","train, test , validation = dftransform.randomSplit([0.6, 0.2, 0.2])\n","print(\"  Train dataset:\", train.count(), \"rows\")\n","print(\"  Test dataset: \", test.count(), \"rows\")\n","print(\"  Test dataset: \", validation.count(), \"rows\")"]},{"cell_type":"code","execution_count":21,"metadata":{"id":"_H4bsMJpAMRb","executionInfo":{"status":"ok","timestamp":1644131476303,"user_tz":0,"elapsed":305,"user":{"displayName":"1982 Avis Priyati","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"04182794466118726271"}}},"outputs":[],"source":["from pyspark.ml.evaluation import RegressionEvaluator\n","from pyspark.ml.recommendation import ALS\n","from pyspark.ml.tuning import CrossValidator, ParamGridBuilder\n","from pyspark.ml import Pipeline\n","from pyspark.sql import Row\n","import numpy as np\n","import math"]},{"cell_type":"code","source":["seed = 5\n","iterations = 10\n","regularization_parameter =0.1\n","ranks = range(4, 12)\n","errors = []\n","err = 0\n","tolerance = 0.02"],"metadata":{"id":"DD2X3xTd34Ud","executionInfo":{"status":"ok","timestamp":1644131488376,"user_tz":0,"elapsed":297,"user":{"displayName":"1982 Avis Priyati","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"04182794466118726271"}}},"execution_count":22,"outputs":[]},{"cell_type":"code","source":["min_error = float('inf')\n","best_rank = -1\n","best_iteration = -1\n","\n","for rank in ranks:\n","    als = ALS(maxIter=iterations, regParam=regularization_parameter, rank=rank,userCol=\"userID_index\", itemCol=\"ISBN_index\", ratingCol=\"rating\")\n","    model = als.fit(train)\n","    predictions = model.transform(validation)\n","    new_predictions = predictions.filter(col('prediction') != np.nan)\n","    evaluator = RegressionEvaluator(metricName=\"rmse\", labelCol=\"rating\", predictionCol=\"prediction\")\n","    rmse = evaluator.evaluate(new_predictions)\n","    errors.append(rmse)\n","\n","    print ('For rank %s the RMSE is %s' % (rank, rmse))\n","    if rmse < min_error:\n","        min_error = rmse\n","        best_rank = rank\n","print ('The best model was trained with rank %s' % best_rank)"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"f-7kYAAI4RDj","executionInfo":{"status":"ok","timestamp":1644145433351,"user_tz":0,"elapsed":849068,"user":{"displayName":"1982 Avis Priyati","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"04182794466118726271"}},"outputId":"5bcfbd41-903b-4329-c63c-dfa8f472997e"},"execution_count":32,"outputs":[{"output_type":"stream","name":"stdout","text":["For rank 4 the RMSE is 4.990391576416798\n","For rank 5 the RMSE is 4.7077810203760775\n","For rank 6 the RMSE is 4.419311341671302\n","For rank 7 the RMSE is 4.3835069143763254\n","For rank 8 the RMSE is 4.311952576778448\n","For rank 9 the RMSE is 4.231487313177906\n","For rank 10 the RMSE is 4.198496600975981\n","For rank 11 the RMSE is 4.10756542679242\n","The best model was trained with rank 11\n"]}]},{"cell_type":"code","source":["als = ALS(maxIter=iterations, regParam=regularization_parameter, rank=rank, userCol=\"userID_index\", itemCol=\"ISBN_index\", ratingCol=\"rating\")\n","paramGrid = ParamGridBuilder() \\\n","    .addGrid(als.regParam, [0.1, 0.01]) \\\n","    .addGrid(als.rank, range(4, 12)) \\\n","    .build()\n","evaluator = RegressionEvaluator(metricName=\"rmse\", labelCol=\"rating\", predictionCol=\"prediction\")\n","crossval = CrossValidator(estimator=als,\n","                          estimatorParamMaps=paramGrid,\n","                          evaluator=evaluator,\n","                          numFolds=5)\n","cvModel = crossval.fit(train)"],"metadata":{"id":"bUvMazBX78OU","executionInfo":{"status":"ok","timestamp":1644139845377,"user_tz":0,"elapsed":7139567,"user":{"displayName":"1982 Avis Priyati","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"04182794466118726271"}}},"execution_count":26,"outputs":[]},{"cell_type":"code","source":["cvModel_pred = cvModel.transform(validation)\n","cvModel_pred = cvModel_pred.filter(col('prediction') != np.nan)\n","rmse = evaluator.evaluate(cvModel_pred)\n","print (\"the rmse for optimal grid parameters with cross validation is: {}\".format(rmse))"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"fVV_cm-89qfk","executionInfo":{"status":"ok","timestamp":1644145552796,"user_tz":0,"elapsed":62943,"user":{"displayName":"1982 Avis Priyati","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"04182794466118726271"}},"outputId":"ae6b2630-c2dd-46d1-c50b-e090b3ac799a"},"execution_count":33,"outputs":[{"output_type":"stream","name":"stdout","text":["the rmse for optimal grid parameters with cross validation is: 1.587585319636005\n"]}]},{"cell_type":"code","execution_count":null,"metadata":{"colab":{"background_save":true},"id":"JGqyplx69y9v"},"outputs":[],"source":["# Define evaluator as RMSE and print length of evaluator\n","evaluator = RegressionEvaluator(\n","           metricName=\"rmse\", \n","           labelCol=\"rating\", \n","           predictionCol=\"prediction\") \n","print (\"Num models to be tested: \", len(paramGrid))"]},{"cell_type":"code","execution_count":35,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"Tw4jLrxLSwPN","executionInfo":{"status":"ok","timestamp":1644147556339,"user_tz":0,"elapsed":35932,"user":{"displayName":"1982 Avis Priyati","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"04182794466118726271"}},"outputId":"f7b8be36-ae31-4680-8fdd-bcfcdd57263a"},"outputs":[{"output_type":"stream","name":"stdout","text":["+------+----------+------+----------+------------+----------+\n","|userID|      ISBN|rating|ISBN_index|userID_index|prediction|\n","+------+----------+------+----------+------------+----------+\n","| 28177|0060977493|     5|     148.0|       879.0| 7.2028933|\n","| 10681|0060977493|     6|     148.0|      6606.0|   6.10904|\n","| 90469|0060977493|     9|     148.0|     66617.0|  8.945904|\n","| 92498|0060977493|     9|     148.0|       887.0|  8.085453|\n","|114669|0060977493|     8|     148.0|     31210.0|  7.951915|\n","|161041|0060977493|     1|     148.0|       552.0| 4.6391315|\n","|248170|0060977493|    10|     148.0|      8861.0|  9.989294|\n","| 87938|0060977493|     7|     148.0|      1001.0|  6.410801|\n","|215375|0060977493|     8|     148.0|     14074.0|  7.020451|\n","|243531|0060977493|    10|     148.0|     51238.0|  9.939893|\n","+------+----------+------+----------+------------+----------+\n","only showing top 10 rows\n","\n"]}],"source":["pred = cvModel.transform(test)\n","pred.show(10)"]},{"cell_type":"markdown","metadata":{"id":"v3MVEPh3ErvH"},"source":["***Data Sparsity and Cold Start***"]},{"cell_type":"code","execution_count":36,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"wmZ5NdIGEjA4","outputId":"6f530049-473c-4278-e556-8c9f57b63fdf","executionInfo":{"status":"ok","timestamp":1644147593946,"user_tz":0,"elapsed":5185,"user":{"displayName":"1982 Avis Priyati","photoUrl":"https://lh3.googleusercontent.com/a/default-user=s64","userId":"04182794466118726271"}}},"outputs":[{"output_type":"stream","name":"stdout","text":["The ratings dataframe is  100.00% sparse.\n"]}],"source":["def get_mat_sparsity(ratings):\n","    # Count the total number of ratings in the dataset\n","    count_nonzero = df.select(\"rating\").count()\n","\n","    # Count the number of distinct userIds and distinct movieIds\n","    total_elements = df.select(\"userID\").distinct().count() * ratings.select(\"ISBN\").distinct().count()\n","\n","    # Divide the numerator by the denominator\n","    sparsity = (1.0 - (count_nonzero *1.0)/total_elements)*100\n","    print(\"The ratings dataframe is \", \"%.2f\" % sparsity + \"% sparse.\")\n","    \n","get_mat_sparsity(df)"]}],"metadata":{"colab":{"collapsed_sections":[],"name":"ALSWR-Bookcrossing","provenance":[{"file_id":"1Yxh-GfmSgsCfizoiLddZjRRmiEoqKSdM","timestamp":1644130370325},{"file_id":"1dwyEq7SCRGYjvgA4BJpP-gugvjeAuzdM","timestamp":1643940751297},{"file_id":"1w19vf4-cxQduC-_L5v5gF_UVldxrlF4u","timestamp":1643029598655}],"authorship_tag":"ABX9TyMtqPrnMX7ruhBHKmOXbCZq"},"kernelspec":{"display_name":"Python 3","name":"python3"},"language_info":{"name":"python"}},"nbformat":4,"nbformat_minor":0}